---
title: Blockæ˜¯å¦‚ä½•å®ç°ï¼Ÿ
date: 2016-12-7 16:50:00.000000000 +08:00
tags: Objective-C
---

## å‰è¨€

æ–‡ç« æ˜¯é˜…è¯»[ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹:iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹](https://book.douban.com/subject/24720270/)ä¹‹åçš„ä¸€äº›ç†è§£æ€»ç»“ã€‚

---

ç†è§£Blockå¦‚ä½•å®ç°,éœ€è¦äº†è§£

*	ä»€ä¹ˆæ˜¯`Block`?
*	`Block`çš„è¯­æ³•



## ä»€ä¹ˆæ˜¯Block

`Block`æ˜¯`C`è¯­è¨€çš„æ‹“å±•åŠŸèƒ½ã€‚åœ¨Appleæ–‡æ¡£ä¸­æœ‰ä¸€å¥è¯è¯´æ˜ï¼š

```
In other languages and environments, a block object is sometimes also called a closure or a lambda.
```

å…¶ä»–è¯­è¨€å’Œç¯å¢ƒï¼Œä¸€ä¸ª`block`å¯¹è±¡æœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä½œ`closure`é—­åŒ…æˆ–`^`;

åœ¨é˜®ä¸€å³°çš„[å­¦ä¹ Javascripté—­åŒ…ï¼ˆClosureï¼‰](http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html)ä¸­è§£é‡Šäº†ä»€ä¹ˆæ˜¯é—­åŒ…ã€‚

**é—­åŒ…å°±æ˜¯èƒ½å¤Ÿè¯»å–å…¶ä»–å‡½æ•°å†…éƒ¨å˜é‡çš„å‡½æ•°ã€‚**
<!-- more -->
## Blockçš„è¯­æ³•

å£°æ˜ä¸€ä¸ª`Block`

```
NSUInteger (^lengthBlock)(NSString *);
```

1.	`NSUInteger`æ˜¯`Block`è¿”å›çš„å€¼ç±»å‹
2. `^lengthBlock`è¡¨ç¤ºå£°æ˜äº†åå­—`lengthBlock`çš„`Block`
3. `NSString *`è¡¨ç¤º`NSString`ç±»å‹çš„å‚æ•°

åˆ›å»ºä¸€ä¸ª`Block`

```objc
lengthBlock = ^(NSString *str) {
        return str.length;
    };
    NSLog(@"%lu",(unsigned long)lengthBlock(@"123")); // console 3
```

1.	`^(NSString *str)`å¯¹`lengthBlock`çš„å®šä¹‰,åˆ†é…ç»™`lengthBlock`çš„å€¼
2.	`str`å‚æ•°åç§°
3. `{...}`å¤§æ‹¬å¼§æ˜¯`Block`çš„ä¸»ä½“
4. `return str.length`æ˜¯`lengthBlock`çš„è¿”å›å€¼

**`Block`å¯ä»¥ç›´æ¥ä½¿ç”¨ç›¸åŒçš„ä½œç”¨åŸŸå†…å®šä¹‰çš„å˜é‡**

```objc
NSString *string = @"123";
    
    NSUInteger (^lengthBlock)(NSString *) = ^(NSString *str){
        return string.length + str.length;
    };
    NSLog(@"%lu",(unsigned long)lengthBlock(@"456")); // console 6
```

**Blockç±»å‹å˜é‡**

```objc    
- (void)stringWithLengthBlock:(NSUInteger (^)(NSString *))lengthBlock{
    NSLog(@"%lu",lengthBlock(@"456")); // console 6
}

[self stringWithLengthBlock:^NSUInteger(NSString *str) {
        NSString *string = @"123";
        return string.length + str.length;
    }];
```

ä¹Ÿå¯ä»¥ä½¿ç”¨`typedef`å£°æ˜

```objc
typedef void (^Block)(NSString *str);

- (void)stringWithLengthBlock:(Block)block{
    block(@"123");
}
```

## Blockçš„å®ç°

ä¸¾ä¸ªğŸŒ°

```objc
int main(int argc, const char * argv[]) {
    void (^block)(void) = ^{printf("Block\n");};
    block();
    return 0;
}
```

ä½¿ç”¨clangä½¿ç”¨ç¼–è¯‘å™¨æ”¹å†™æ–‡ä»¶
> è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ç¼–è¯‘åçš„ä»£ç åªæ˜¯ä¸ºäº†ç†è§£Blockçš„å®ç°,å¹¶ä¸æ˜¯Blockçš„æºç 

```
clang -rewrite-objc æ–‡ä»¶å
```

ä¸‹é¢è½¬æ¢ä¾‹å­ä»£ç å`Block`çš„ç›¸å…³ä»£ç ï¼š

``` C++
struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
    impl.isa = &_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
printf("Block\n");}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};

int main(int argc, const char * argv[]) {

    void (*block)(void) = ((void (*)
   ())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA));
   
    ((void (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);
    
    return 0;
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ª`__main_block_impl_0`ç»“æ„ä½“åŒ…å«`__block_impl`å’Œ`__main_block_desc_0`ä¸¤ä¸ªç»“æ„ä½“

```C++
struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};
```

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Blockç»“æ„ä½“çš„æ„æˆ

1.	`isa`æŒ‡é’ˆ,ç”¨äºæŒ‡å‘Blockçš„æŒ‡é’ˆ
2.	`Flags` è¡¨ç¤ºBlocké™„åŠ çš„ä¿¡æ¯
3. `Reserved` ä¿ç•™å˜é‡
4. `FuncPtr` å‡½æ•°æŒ‡é’ˆæŒ‡å‘Blockå®ç°çš„å‡½æ•°åœ°å€


å…¶ä¸­`isa`æŒ‡å‘Blockæœ‰ä¸‰ç§ç±»å‹ï¼š

``` C++
isa = &_NSConcreteStackBlock;
isa = &_NSConcreteGlobalBlock;
isa = &_NSConcreteMallocBlock;
```

`__main_block_desc_0`çš„æ„æˆ,ç”¨æ¥æè¿°Blockä¸€äº›ä¿¡æ¯
```C++
static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
```

1.	`reserved`	ä¿ç•™å˜é‡
2. `Block_size`	Blockçš„å¤§å°

ä¸‹é¢çœ‹ä¸€ä¸‹åˆå§‹åŒ–

```C++
impl.isa = &_NSConcreteStackBlock;
```
`_NSConcreteStackBlock` ç”¨æ¥åˆå§‹åŒ–äº†`__block_impl`ç»“æ„ä½“çš„`isa`è¿™é‡Œä¸ºä»€ä¹ˆä½¿ç”¨`_NSConcreteStackBlock`æ¥åˆå§‹åŒ–,è¯´æ˜`Block`åˆ›å»ºåœ¨`Stack`ä¸Š

æ¥ä¸‹æ¥çœ‹ `int main{}`ä¸­çš„è°ƒç”¨

```C++
 void (*block)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA));   
   
// åˆ†æˆä¸¤éƒ¨åˆ†

// ç¬¬ä¸€éƒ¨åˆ†
&__main_block_impl_0 ((void *) __main_block_func_0, &__main_block_desc_0_DATA)

// å»æ‰è½¬æ¢éƒ¨åˆ†
__main_block_impl_0 impl = (__main_block_impl_0(__main_block_func_0,&__main_block_desc_0_DATA));

// ç¬¬äºŒéƒ¨åˆ†
void (*block)(void) =((void (*)())&__main_block_impl_0()
// å»æ‰è½¬æ¢éƒ¨åˆ†
struct __main_block_impl_0 *block = &impl;  // è¿™é‡ŒimplæŒ‡çš„æ˜¯ä¸Šé¢çš„ç¬¬ä¸€éƒ¨åˆ†
```
å°†`__main_block_impl_0`ç»“æ„çš„`impl`å®ä¾‹åœ°å€èµ‹å€¼ç»™`*block`å‡½æ•°æŒ‡é’ˆ

```C++
((void (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);

// å»æ‰è½¬æ¢éƒ¨åˆ†
(*block ->impl.FuncPtr)(block);
```

ä»£ç ä½¿ç”¨äº†[å‡½æ•°æŒ‡é’ˆ](http://baike.baidu.com/link?url=2XOSKIcmha-ntPSox2Rl0mee7lMaJwatpwWzwqvOjU5DAnsEiX8rAXJBTcccpQ9U2EFLDae8YAzSrPnXLONqiiR1vIllvLPvesp-bM1oubRK2y1uFu-2ueudqZDcT1qv#2)è°ƒç”¨å‡½æ•°
å–å‡º`block`çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨`FuncPtr`,ä»¥è‡ªèº«ï¼ˆ`block`ï¼‰ä¸ºå‚æ•°ä¼ å…¥

###	**æ€»ç»“ä¸€ä¸‹`Block`ç®€å•çš„å®ç°æµç¨‹**

```
				main();
				  â¬‡ï¸
	**åˆå§‹åŒ–__main_block_impl_0 ç»“æ„ä½“**
				  â¬‡ï¸
	**å°†ç»“æ„ä½“åœ°å€èµ‹å€¼ç»™*blockå‡½æ•°æŒ‡é’ˆ**
				  â¬‡ï¸
	**è°ƒç”¨blockå‡½æ•°æŒ‡é’ˆçš„FuncPtrå‡½æ•°**
				  â¬‡ï¸
				**ç»“æŸ**
```

##	ç»“å°¾

 `Block`è¿˜æœ‰æˆªè·è‡ªåŠ¨å˜é‡ã€__blockä¿®é¥°ç¬¦ã€blockå­˜å‚¨åŸŸå³ä¸Šæ–‡æåˆ°çš„ä¸‰ç§blockç±»å‹ï¼Œå†…å­˜ç®¡ç†ç­‰ç­‰é—®é¢˜å¾…æˆ‘ç»†ç»†ç ”ä¹ ä¹‹åå†å†™æ€»ç»“ã€‚

## å‚è€ƒèµ„æ–™ 

*	[ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹:iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹](https://book.douban.com/subject/24720270/)
* [è°ˆObjective-C blockçš„å®ç°](http://blog.devtang.com/2013/07/28/a-look-inside-blocks/)
* [å­¦ä¹ Javascripté—­åŒ…(Closure)](http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html)
* [å¯¹Objective-Cä¸­Blockçš„è¿½æ¢](http://www.cnblogs.com/biosli/archive/2013/05/29/iOS_Objective-C_Block.html)


<!â€” more -->

